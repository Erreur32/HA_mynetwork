import{u as ve,a as Ne,b as we,j as e}from"./index-D769t3SB.js";import{r as n,R as ue}from"./vendor-charts-fy94SsLU.js";import{P as _e}from"./PermissionBanner-DQzGv1X1.js";import{af as Se,i as he,ag as Ce,ah as Te,H as ge,m as ke,O as Le,ai as xe,aj as ce,aa as se,Y as me,R as De,a2 as O,ak as Ee,a8 as pe,z as fe,al as Me,X as be}from"./vendor-icons-Wr2_Nvt-.js";import"./vendor-D9iDNHsv.js";import"./vendor-state-CiM9n9np.js";const Re=s=>{const c=Math.floor(s/3600),d=Math.floor(s%3600/60);return c>0?`${c}h${d.toString().padStart(2,"0")}m`:`${d}min`},ye=s=>new Date(s*1e3).toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short",year:"numeric"}),ae=s=>new Date(s*1e3).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}),ze=s=>s<1024*1024?`${(s/1024).toFixed(1)} Ko`:s<1024*1024*1024?`${(s/(1024*1024)).toFixed(1)} Mo`:`${(s/(1024*1024*1024)).toFixed(2)} Go`,re=s=>{const c=s.getFullYear(),d=String(s.getMonth()+1).padStart(2,"0"),x=String(s.getDate()).padStart(2,"0");return`${c}-${d}-${x}`},$e=({recording:s,onDelete:c})=>{const[d,x]=n.useState(!1),h=()=>{d?(c(s.id),x(!1)):(x(!0),setTimeout(()=>x(!1),3e3))};return e.jsxs("div",{className:"bg-[#1a1a1a] rounded-xl border border-gray-800 p-4 hover:border-gray-700 transition-colors",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-medium text-white truncate",children:s.name}),s.sub_name&&e.jsx("p",{className:"text-sm text-gray-400 truncate",children:s.sub_name}),(s.season||s.episode)&&e.jsxs("p",{className:"text-xs text-gray-500",children:[s.season&&`S${s.season.toString().padStart(2,"0")}`,s.episode&&`E${s.episode.toString().padStart(2,"0")}`]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[s.state==="running"&&e.jsxs("span",{className:"flex items-center gap-1 px-2 py-1 rounded-full text-xs bg-red-500/20 text-red-400",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-red-500 animate-pulse"}),"En cours"]}),e.jsx("button",{onClick:h,className:`p-2 rounded-lg transition-colors ${d?"bg-red-500/20 text-red-400 hover:bg-red-500/30":"hover:bg-gray-700 text-gray-400 hover:text-white"}`,title:d?"Confirmer la suppression":"Supprimer",children:e.jsx(pe,{size:16})})]})]}),e.jsxs("div",{className:"mt-3 flex flex-wrap items-center gap-3 text-xs text-gray-500",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(se,{size:12}),ye(s.start)]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(fe,{size:12}),ae(s.start)," - ",ae(s.end)]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ce,{size:12}),Re(s.duration)]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ge,{size:12}),ze(s.byte_size)]})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between",children:[e.jsxs("span",{className:"px-2 py-1 rounded-full text-xs bg-gray-800 text-gray-400",children:[s.channel_name||s.channel_type," - ",s.channel_quality]}),e.jsxs("button",{className:"flex items-center gap-1 px-3 py-1.5 rounded-lg bg-blue-600 hover:bg-blue-500 text-white text-xs font-medium transition-colors",children:[e.jsx(Me,{size:12}),"Lire"]})]})]})},Pe=({programmed:s,onDelete:c})=>{const[d,x]=n.useState(!1),h=()=>{d?(c(s.id),x(!1)):(x(!0),setTimeout(()=>x(!1),3e3))},r=s.state==="running"||s.state==="starting",m=s.end*1e3<Date.now(),i=[];return s.repeat_monday&&i.push("Lun"),s.repeat_tuesday&&i.push("Mar"),s.repeat_wednesday&&i.push("Mer"),s.repeat_thursday&&i.push("Jeu"),s.repeat_friday&&i.push("Ven"),s.repeat_saturday&&i.push("Sam"),s.repeat_sunday&&i.push("Dim"),e.jsxs("div",{className:`bg-[#1a1a1a] rounded-xl border p-4 transition-colors ${r?"border-red-500/50":m?"border-gray-700 opacity-60":"border-gray-800 hover:border-gray-700"}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-medium text-white truncate",children:s.name}),s.sub_name&&e.jsx("p",{className:"text-sm text-gray-400 truncate",children:s.sub_name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[r&&e.jsxs("span",{className:"flex items-center gap-1 px-2 py-1 rounded-full text-xs bg-red-500/20 text-red-400",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-red-500 animate-pulse"}),"Enregistrement"]}),!s.enabled&&e.jsx("span",{className:"px-2 py-1 rounded-full text-xs bg-gray-700 text-gray-400",children:"Désactivé"}),e.jsx("button",{onClick:h,className:`p-2 rounded-lg transition-colors ${d?"bg-red-500/20 text-red-400 hover:bg-red-500/30":"hover:bg-gray-700 text-gray-400 hover:text-white"}`,title:d?"Confirmer la suppression":"Supprimer",children:e.jsx(pe,{size:16})})]})]}),e.jsxs("div",{className:"mt-3 flex flex-wrap items-center gap-3 text-xs text-gray-500",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(se,{size:12}),ye(s.start)]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(fe,{size:12}),ae(s.start)," - ",ae(s.end)]}),i.length>0&&e.jsxs("span",{className:"px-2 py-0.5 rounded-full bg-purple-500/20 text-purple-400",children:["Répétition: ",i.join(", ")]})]}),e.jsx("div",{className:"mt-3",children:e.jsxs("span",{className:"px-2 py-1 rounded-full text-xs bg-gray-800 text-gray-400",children:[s.channel_name||s.channel_type," - ",s.channel_quality]})})]})},Fe=({program:s,visible:c,position:d})=>{if(!c)return null;const x=new Date(s.date*1e3),h=new Date((s.date+s.duration)*1e3),r=i=>i.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}),m=i=>i.toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"});return e.jsxs("div",{className:"fixed z-50 max-w-xs bg-[#1a1a1a] border border-gray-700 rounded-lg shadow-xl p-3 pointer-events-none",style:{left:`${d.x}px`,top:`${d.y}px`,transform:"translate(-50%, -100%) translateY(-10px)"},children:[e.jsxs("div",{className:"text-xs text-gray-500 mb-1",children:[s.channelName," • ",m(x)," ",r(x)," - ",r(h)]}),e.jsx("div",{className:"font-medium text-white text-sm",children:s.title}),s.category_name&&e.jsx("div",{className:"text-xs text-purple-400 mt-1",children:s.category_name}),s.desc&&e.jsx("p",{className:"text-xs text-gray-400 mt-2 line-clamp-3",children:s.desc}),e.jsx("div",{className:"text-[10px] text-gray-600 mt-2",children:"Cliquer pour enregistrer"})]})},Ve=({programs:s,onRecord:c,freeboxUrl:d,onLoadMore:x,onDateChange:h,timelineStartTimestamp:r,onTimelineStartChange:m})=>{const[i,N]=n.useState(15),[k,T]=n.useState(null),[y,l]=n.useState(12),[b,M]=n.useState(""),[I,L]=n.useState(()=>re(new Date(r*1e3)));n.useEffect(()=>{L(re(new Date(r*1e3)))},[r]);const[R,Z]=n.useState(!1),W=n.useRef(!1),Y=n.useRef(null),E=n.useRef(null),z=n.useRef(null),$=n.useRef(null),w=n.useRef(Math.floor(Date.now()/1e3)).current,J=n.useRef(!1),_=n.useRef(!1),H=n.useRef(y),p=r,K=y*60*60,D=p+K,j=4,X=n.useRef(new Set);n.useEffect(()=>{H.current=y},[y]);const G=n.useCallback(()=>{if(!E.current)return null;const t=E.current,a=t.scrollLeft,o=t.clientWidth,u=a/j,g=(a+o)/j,f=p+u*60,C=p+g*60;return{visibleStartTs:f,visibleEndTs:C}},[p,j]),P=n.useCallback(()=>{if(W.current)return;const t=G();if(!t)return;const{visibleEndTs:a}=t,o=H.current,u=3600;if(a+u>D&&o<48){const q=Math.min(o+6,48);l(q)}const f=7200,C=Math.floor((t.visibleStartTs-u)/f)*f,de=Math.floor((a+u)/f)*f,A=[];for(let q=C;q<=de;q+=f)X.current.has(q)||A.push(q);A.length>0&&x&&(W.current=!0,Z(!0),A.forEach(B=>X.current.add(B)),(async()=>{for(let B=0;B<A.length;B++)B>0&&await new Promise(je=>setTimeout(je,300)),x(A[B]);setTimeout(()=>{W.current=!1,Z(!1)},500)})())},[G,D,x]);n.useEffect(()=>{const t=E.current;if(t)return t.addEventListener("scroll",P),()=>t.removeEventListener("scroll",P)},[P]),n.useEffect(()=>{const t=setInterval(P,500);return()=>clearInterval(t)},[P]),n.useEffect(()=>{X.current.clear()},[r]);const U=n.useCallback(t=>{if(J.current)return;J.current=!0;const a=z.current,o=$.current;a&&o&&(t==="channels"?o.scrollTop=a.scrollTop:a.scrollTop=o.scrollTop),requestAnimationFrame(()=>{J.current=!1})},[]);n.useEffect(()=>{const t=z.current,a=$.current,o=()=>U("channels"),u=()=>U("programs");return t&&t.addEventListener("scroll",o),a&&a.addEventListener("scroll",u),()=>{t&&t.removeEventListener("scroll",o),a&&a.removeEventListener("scroll",u)}},[U]);const F=new Map;s.forEach(t=>{t.date+t.duration>p&&t.date<D&&(F.has(t.channelUuid)||F.set(t.channelUuid,{uuid:t.channelUuid,name:t.channelName||"Chaîne",logo:t.channelLogo,number:t.channelNumber,programs:[]}),F.get(t.channelUuid).programs.push(t))});const v=Array.from(F.values()).map(t=>{t.programs.sort((u,g)=>u.date-g.date);const a=new Set,o=[];for(const u of t.programs){if(a.has(u.id))continue;a.add(u.id);const g=o[o.length-1];g&&u.date<g.date+g.duration||o.push(u)}return t.programs=o,t}).filter(t=>{if(!b)return!0;const a=b.toLowerCase();return t.name.toLowerCase().includes(a)||t.number&&t.number.toString().includes(a)}).sort((t,a)=>(t.number||999)-(a.number||999)),ne=t=>{const a=t.target.value;L(a);const[o,u,g]=a.split("-").map(Number),f=new Date(o,u-1,g,0,0,0,0),C=Math.floor(f.getTime()/1e3);m(C),_.current=!1,h&&h(C)},ee=[];let S=Math.floor(p/1800)*1800;for(;S<=D;){if(S>=p){const t=new Date(S*1e3),a=t.toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"}),o=t.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}),u=t.getHours(),f=t.getMinutes()===0&&u%2===0;ee.push({time:S,label:o,dateLabel:f?a:void 0})}S+=1800}const V=n.useCallback(()=>{const t=z.current,a=$.current,o=t||a;if(!o)return;o.scrollHeight-o.scrollTop-o.clientHeight<200&&i<v.length&&N(g=>Math.min(g+10,v.length))},[i,v.length]);n.useEffect(()=>{const t=z.current,a=$.current;return t&&t.addEventListener("scroll",V),a&&a.addEventListener("scroll",V),()=>{t&&t.removeEventListener("scroll",V),a&&a.removeEventListener("scroll",V)}},[V]),n.useEffect(()=>{const t=new IntersectionObserver(a=>{a[0].isIntersecting&&i<v.length&&N(o=>Math.min(o+10,v.length))},{threshold:.1});return Y.current&&t.observe(Y.current),()=>t.disconnect()},[i,v.length]),n.useEffect(()=>{if(E.current&&!_.current)if(_.current=!0,w>=p&&w<=D){const a=(w-p)/60*j;E.current.scrollLeft=Math.max(0,a-100)}else E.current.scrollLeft=0},[w,p,D,j]);const le=t=>{const a=Math.max(t.date,p),u=Math.min(t.date+t.duration,D)-a,g=(a-p)/60*j,f=Math.max(50,u/60*j-2);return{left:`${g}px`,width:`${f}px`}},ie=t=>{const a=t.date+t.duration;return w>=t.date&&w<a},Q=w>=p&&w<=D,te=Q?(w-p)/60*j:-1,oe=K/60*j;return e.jsxs("div",{className:"border border-gray-800 rounded-xl overflow-hidden bg-[#0a0a0a]",children:[e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-[#151515] border-b border-gray-800",children:[e.jsx("div",{className:"flex-1 max-w-xs",children:e.jsx("input",{type:"text",value:b,onChange:t=>M(t.target.value),placeholder:"Filtrer les chaînes...",className:"w-full px-3 py-1.5 bg-[#1a1a1a] border border-gray-700 rounded-lg text-white text-sm placeholder-gray-500 focus:outline-none focus:border-purple-500"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-xs text-gray-500",children:"Date:"}),e.jsx("input",{type:"date",value:I,onChange:ne,className:"px-3 py-1.5 bg-[#1a1a1a] border border-gray-700 rounded-lg text-white text-sm focus:outline-none focus:border-purple-500 [color-scheme:dark]"})]}),e.jsxs("span",{className:"text-xs text-gray-500",children:[v.length," chaîne",v.length>1?"s":""]})]}),e.jsxs("div",{className:"flex relative",children:[e.jsxs("div",{className:"flex-shrink-0 w-32 md:w-40",children:[e.jsx("div",{className:"h-12 bg-[#151515] p-2 flex items-end text-xs text-gray-500 font-medium border-b border-r border-gray-800",children:"Chaîne"}),e.jsxs("div",{ref:z,className:"max-h-[60vh] overflow-y-auto overflow-x-hidden",children:[v.slice(0,i).map(t=>e.jsxs("div",{className:"h-14 p-2 flex items-center gap-2 border-b border-r border-gray-800 bg-[#0f0f0f] hover:bg-[#111]",children:[e.jsx("div",{className:"w-8 h-8 rounded bg-gray-800 overflow-hidden flex items-center justify-center flex-shrink-0",children:t.logo?e.jsx("img",{src:`${d}${t.logo}`,alt:"",className:"w-full h-full object-contain",onError:a=>{a.target.style.display="none"}}):e.jsx(he,{size:14,className:"text-gray-600"})}),e.jsxs("div",{className:"min-w-0",children:[t.number&&e.jsx("span",{className:"text-[10px] text-gray-600 font-medium",children:t.number}),e.jsx("p",{className:"text-xs text-white truncate",children:t.name})]})]},t.uuid)),i<v.length&&e.jsxs("div",{ref:Y,className:"flex items-center justify-center py-4",children:[e.jsx(O,{size:20,className:"text-gray-600 animate-spin"}),e.jsxs("span",{className:"ml-2 text-xs text-gray-500",children:[i,"/",v.length]})]})]})]}),e.jsx("div",{ref:E,className:"flex-1 overflow-x-auto overflow-y-hidden scrollbar-thin scrollbar-thumb-gray-700",children:e.jsxs("div",{style:{width:`${oe}px`},children:[e.jsxs("div",{className:"relative h-12 border-b border-gray-800 bg-[#0a0a0a]",children:[ee.map(t=>e.jsxs("div",{className:"absolute top-0 h-full flex flex-col justify-end pb-0.5 border-l border-gray-700 pl-1",style:{left:`${(t.time-p)/60*j}px`},children:[t.dateLabel&&e.jsx("span",{className:"text-[10px] text-purple-400 font-medium whitespace-nowrap leading-tight",children:t.dateLabel}),e.jsx("span",{className:"text-xs text-gray-500 leading-tight",children:t.label})]},t.time)),Q&&e.jsx("div",{className:"absolute top-0 h-full w-0.5 bg-red-500 z-10",style:{left:`${te}px`}})]}),e.jsx("div",{ref:$,className:"max-h-[60vh] overflow-y-auto",children:v.slice(0,i).map(t=>e.jsxs("div",{className:"relative h-14 border-b border-gray-800/50 hover:bg-[#111]/50",children:[Q&&e.jsx("div",{className:"absolute top-0 h-full w-0.5 bg-red-500/30 z-10 pointer-events-none",style:{left:`${te}px`}}),t.programs.map(a=>{const o=le(a),u=ie(a);return e.jsx("button",{onClick:()=>c(a),onMouseEnter:g=>{const f=g.currentTarget.getBoundingClientRect();T({program:a,x:f.left+f.width/2,y:f.top})},onMouseLeave:()=>T(null),className:`absolute top-1 h-12 rounded px-1.5 text-left overflow-hidden transition-colors ${u?"bg-red-900/40 border border-red-500/50 hover:bg-red-900/60":"bg-[#1a1a1a] border border-gray-700 hover:border-purple-500 hover:bg-[#1f1f1f]"}`,style:o,children:e.jsxs("div",{className:"flex items-center gap-1 h-full",children:[u&&e.jsx(Ee,{size:5,className:"text-red-400 fill-current flex-shrink-0"}),e.jsx("span",{className:"text-[11px] font-medium text-white truncate leading-tight",children:a.title})]})},`${a.id}-${a.date}`)})]},t.uuid))})]})}),R&&e.jsx("div",{className:"absolute right-0 top-0 bottom-0 w-20 flex items-center justify-center bg-gradient-to-l from-[#0a0a0a] via-[#0a0a0a]/90 to-transparent pointer-events-none z-20",children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx(O,{size:24,className:"text-purple-400 animate-spin"}),e.jsx("span",{className:"text-[10px] text-gray-400 font-medium",children:"Chargement..."})]})})]}),k&&e.jsx(Fe,{program:k.program,visible:!0,position:{x:k.x,y:k.y}})]})},Ae=({isOpen:s,onClose:c,currentConfig:d,onSave:x})=>{const[h,r]=n.useState(0),[m,i]=n.useState(0),[N,k]=n.useState(!1);ue.useEffect(()=>{d&&s&&(r(Math.floor(d.margin_before/60)),i(Math.floor(d.margin_after/60)))},[d,s]);const T=async()=>{k(!0);try{await x({margin_before:h*60,margin_after:m*60})&&c()}finally{k(!1)}};return s?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4",children:e.jsxs("div",{className:"bg-[#151515] w-full max-w-md rounded-2xl border border-gray-800 shadow-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-800",children:[e.jsx("h2",{className:"text-lg font-bold text-white",children:"Configuration PVR"}),e.jsx("button",{onClick:c,className:"p-2 hover:bg-gray-800 rounded-lg",children:e.jsx(be,{size:20})})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-400",children:"Configurez les marges par défaut pour les enregistrements. Ces marges permettent de commencer l'enregistrement avant l'heure prévue et de le terminer après."}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-2",children:"Marge avant (minutes)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"range",min:"0",max:"30",value:h,onChange:y=>r(parseInt(y.target.value)),className:"flex-1 accent-purple-500"}),e.jsx("span",{className:"w-12 text-center text-white font-medium",children:h})]}),e.jsxs("p",{className:"text-xs text-gray-600 mt-1",children:["Démarre ",h," min avant"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-2",children:"Marge après (minutes)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"range",min:"0",max:"60",value:m,onChange:y=>i(parseInt(y.target.value)),className:"flex-1 accent-purple-500"}),e.jsx("span",{className:"w-12 text-center text-white font-medium",children:m})]}),e.jsxs("p",{className:"text-xs text-gray-600 mt-1",children:["Termine ",m," min après"]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-4 border-t border-gray-800",children:[e.jsx("button",{onClick:c,className:"flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors",children:"Annuler"}),e.jsxs("button",{onClick:T,disabled:N,className:"flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg transition-colors disabled:opacity-50 flex items-center justify-center gap-2",children:[N&&e.jsx(O,{size:16,className:"animate-spin"}),"Enregistrer"]})]})]})}):null},qe=({isOpen:s,onClose:c,onSave:d,channels:x,prefillProgram:h})=>{var y;const[r,m]=n.useState({name:"",channel_uuid:((y=x[0])==null?void 0:y.uuid)||"",channel_type:"tnt",channel_quality:"hd",start_date:"",start_time:"",end_time:"",margin_before:5,margin_after:10,repeat_monday:!1,repeat_tuesday:!1,repeat_wednesday:!1,repeat_thursday:!1,repeat_friday:!1,repeat_saturday:!1,repeat_sunday:!1}),[i,N]=n.useState(!1);ue.useEffect(()=>{if(s)if(h){const l=new Date(h.date*1e3),b=new Date((h.date+h.duration)*1e3);m({name:h.title,channel_uuid:h.channelUuid,channel_type:"tnt",channel_quality:"hd",start_date:re(l),start_time:l.toTimeString().slice(0,5),end_time:b.toTimeString().slice(0,5),margin_before:5,margin_after:10,repeat_monday:!1,repeat_tuesday:!1,repeat_wednesday:!1,repeat_thursday:!1,repeat_friday:!1,repeat_saturday:!1,repeat_sunday:!1})}else{const l=new Date,b=re(l),M=l.toTimeString().slice(0,5),I=new Date(l.getTime()+3600*1e3).toTimeString().slice(0,5);m(L=>{var R;return{...L,name:"",channel_uuid:((R=x[0])==null?void 0:R.uuid)||"",start_date:b,start_time:M,end_time:I}})}},[s,h,x]);const k=async()=>{if(!(!r.name||!r.channel_uuid||!r.start_date||!r.start_time||!r.end_time)){N(!0);try{const l=new Date(`${r.start_date}T${r.start_time}`),b=new Date(`${r.start_date}T${r.end_time}`);b<=l&&b.setDate(b.getDate()+1),await d({name:r.name,channel_uuid:r.channel_uuid,channel_type:r.channel_type,channel_quality:r.channel_quality,start:Math.floor(l.getTime()/1e3),end:Math.floor(b.getTime()/1e3),margin_before:r.margin_before*60,margin_after:r.margin_after*60,enabled:!0,repeat_monday:r.repeat_monday,repeat_tuesday:r.repeat_tuesday,repeat_wednesday:r.repeat_wednesday,repeat_thursday:r.repeat_thursday,repeat_friday:r.repeat_friday,repeat_saturday:r.repeat_saturday,repeat_sunday:r.repeat_sunday})&&c()}finally{N(!1)}}};if(!s)return null;const T=x.find(l=>l.uuid===r.channel_uuid);return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4",children:e.jsxs("div",{className:"bg-[#151515] w-full max-w-lg rounded-2xl border border-gray-800 shadow-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-800 sticky top-0 bg-[#151515]",children:[e.jsx("h2",{className:"text-lg font-bold text-white",children:"Programmer un enregistrement"}),e.jsx("button",{onClick:c,className:"p-2 hover:bg-gray-800 rounded-lg",children:e.jsx(be,{size:20})})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Nom de l'enregistrement"}),e.jsx("input",{type:"text",value:r.name,onChange:l=>m({...r,name:l.target.value}),className:"w-full px-3 py-2 bg-[#1a1a1a] border border-gray-700 rounded-lg text-white text-sm focus:outline-none focus:border-purple-500",placeholder:"Mon émission"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Chaîne"}),e.jsx("select",{value:r.channel_uuid,onChange:l=>m({...r,channel_uuid:l.target.value}),className:"w-full px-3 py-2 bg-[#1a1a1a] border border-gray-700 rounded-lg text-white text-sm focus:outline-none focus:border-purple-500",children:x.map(l=>e.jsxs("option",{value:l.uuid,children:[l.number," - ",l.name]},l.uuid))}),T&&e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Chaîne sélectionnée: ",T.name]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Date"}),e.jsx("input",{type:"date",value:r.start_date,onChange:l=>m({...r,start_date:l.target.value}),className:"w-full px-3 py-2 bg-[#1a1a1a] border border-gray-700 rounded-lg text-white text-sm focus:outline-none focus:border-purple-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Début"}),e.jsx("input",{type:"time",value:r.start_time,onChange:l=>m({...r,start_time:l.target.value}),className:"w-full px-3 py-2 bg-[#1a1a1a] border border-gray-700 rounded-lg text-white text-sm focus:outline-none focus:border-purple-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Fin"}),e.jsx("input",{type:"time",value:r.end_time,onChange:l=>m({...r,end_time:l.target.value}),className:"w-full px-3 py-2 bg-[#1a1a1a] border border-gray-700 rounded-lg text-white text-sm focus:outline-none focus:border-purple-500"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Marge avant (min)"}),e.jsx("input",{type:"number",value:r.margin_before,onChange:l=>m({...r,margin_before:parseInt(l.target.value)||0}),className:"w-full px-3 py-2 bg-[#1a1a1a] border border-gray-700 rounded-lg text-white text-sm focus:outline-none focus:border-purple-500",min:"0",max:"30"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Marge après (min)"}),e.jsx("input",{type:"number",value:r.margin_after,onChange:l=>m({...r,margin_after:parseInt(l.target.value)||0}),className:"w-full px-3 py-2 bg-[#1a1a1a] border border-gray-700 rounded-lg text-white text-sm focus:outline-none focus:border-purple-500",min:"0",max:"60"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-2",children:"Répétition"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:[{key:"repeat_monday",label:"Lun"},{key:"repeat_tuesday",label:"Mar"},{key:"repeat_wednesday",label:"Mer"},{key:"repeat_thursday",label:"Jeu"},{key:"repeat_friday",label:"Ven"},{key:"repeat_saturday",label:"Sam"},{key:"repeat_sunday",label:"Dim"}].map(({key:l,label:b})=>e.jsx("button",{type:"button",onClick:()=>m({...r,[l]:!r[l]}),className:`px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ${r[l]?"bg-purple-600 text-white":"bg-gray-800 text-gray-400 hover:bg-gray-700"}`,children:b},l))})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-4 border-t border-gray-800 sticky bottom-0 bg-[#151515]",children:[e.jsx("button",{onClick:c,className:"flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors",children:"Annuler"}),e.jsxs("button",{onClick:k,disabled:i||!r.name||!r.channel_uuid,className:"flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg transition-colors disabled:opacity-50 flex items-center justify-center gap-2",children:[i&&e.jsx(O,{size:16,className:"animate-spin"}),"Programmer"]})]})]})})},We=({onBack:s})=>{const{info:c}=ve(),{channels:d,recordings:x,programmed:h,pvrConfig:r,epgPrograms:m,epgLoading:i,epgRateLimited:N,epgRateLimitedUntil:k,isLoading:T,error:y,fetchChannels:l,fetchRecordings:b,fetchProgrammed:M,fetchPvrConfig:I,fetchEpgByTime:L,clearEpgCache:R,clearRateLimit:Z,deleteRecording:W,deleteProgrammed:Y,createProgrammed:E,updatePvrConfig:z}=Ne(),{permissions:$,freeboxUrl:w}=we(),J=$.pvr===!0,[_,H]=n.useState("recordings"),[p,K]=n.useState("grid"),[D,j]=n.useState(!1),[X,G]=n.useState(!1),[P,U]=n.useState(null),[F,v]=n.useState(null),[ne,ee]=n.useState(()=>Math.floor(Date.now()/1e3)-1800),S=(c==null?void 0:c.disk_status)==="active"||(c==null?void 0:c.user_main_storage);n.useEffect(()=>{l(),S&&(b(),M(),I())},[S,l,b,M,I]),n.useEffect(()=>{if(_==="guide"&&d.length>0&&!N){const u=(F||Math.floor(Date.now()/1e3))-2*7200;let g=!1;return(async()=>{for(let C=0;C<=8&&!(g||(C>0&&await new Promise(A=>setTimeout(A,500)),g)||(await L(u+C*7200,C>0)).rateLimited);C++);})(),()=>{g=!0}}},[_,d.length,L,F,N]);const V=async a=>{await W(a)},le=async a=>{await Y(a)},ie=a=>{U(a),j(!0)},Q=()=>{L()},te=n.useCallback(a=>{L(a,!0)},[L]),oe=n.useCallback(a=>{R(),v(a)},[R]),t=n.useCallback(a=>{ee(a)},[]);return e.jsxs("div",{className:"min-h-screen bg-[#050505] text-gray-300",children:[e.jsx("header",{className:"sticky top-0 z-40 bg-[#0a0a0a]/95 backdrop-blur-sm border-b border-gray-800",children:e.jsx("div",{className:"max-w-[1920px] mx-auto px-4 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:s,className:"p-2 hover:bg-gray-800 rounded-lg transition-colors",children:e.jsx(Se,{size:24})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-purple-500/20 rounded-lg",children:e.jsx(he,{size:24,className:"text-purple-400"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-white",children:"Télévision"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Enregistrements PVR"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>K("grid"),className:`p-2 rounded-lg transition-colors ${p==="grid"?"bg-gray-700 text-white":"text-gray-400 hover:bg-gray-800 hover:text-white"}`,children:e.jsx(Ce,{size:20})}),e.jsx("button",{onClick:()=>K("list"),className:`p-2 rounded-lg transition-colors ${p==="list"?"bg-gray-700 text-white":"text-gray-400 hover:bg-gray-800 hover:text-white"}`,children:e.jsx(Te,{size:20})})]})]})})}),e.jsxs("main",{className:"max-w-[1920px] mx-auto px-4 py-6 pb-24",children:[!S&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-16",children:[e.jsx(ge,{size:64,className:"text-gray-600 mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-white mb-2",children:"Aucun disque détecté"}),e.jsx("p",{className:"text-gray-500 text-center max-w-md",children:"Connectez un disque dur à votre Freebox pour utiliser la fonctionnalité d'enregistrement TV (PVR)."})]}),S&&e.jsx("div",{className:"mb-6 p-4 bg-[#151515] border border-gray-800 rounded-xl",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>G(!0),className:"p-2 rounded-lg bg-emerald-500/20 hover:bg-emerald-500/30 transition-colors",title:"Configurer les marges",children:e.jsx(ke,{size:20,className:"text-emerald-400"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-white",children:"Enregistreur PVR"}),r?e.jsxs("button",{onClick:()=>G(!0),className:"text-xs text-gray-500 hover:text-gray-400 transition-colors",children:["Marges: -",Math.floor(r.margin_before/60),"min / +",Math.floor(r.margin_after/60),"min"]}):e.jsx("p",{className:"text-xs text-gray-500",children:"Chargement..."})]})]}),e.jsx("div",{className:"flex items-center gap-3",children:d.length>0&&e.jsxs("button",{onClick:()=>j(!0),className:"flex items-center gap-2 px-3 py-1.5 bg-purple-600 hover:bg-purple-500 text-white text-xs font-medium rounded-lg transition-colors",children:[e.jsx(Le,{size:14}),"Programmer"]})})]})}),e.jsxs("div",{className:"flex items-center gap-4 mb-6 border-b border-gray-800",children:[e.jsx("button",{onClick:()=>H("guide"),className:`px-4 py-3 text-sm font-medium transition-colors border-b-2 -mb-px ${_==="guide"?"text-red-400 border-red-400":"text-gray-400 border-transparent hover:text-white"}`,children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(xe,{size:16}),"Guide TV"]})}),S&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>H("recordings"),className:`px-4 py-3 text-sm font-medium transition-colors border-b-2 -mb-px ${_==="recordings"?"text-purple-400 border-purple-400":"text-gray-400 border-transparent hover:text-white"}`,children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(ce,{size:16}),"Enregistrements (",x.length,")"]})}),e.jsx("button",{onClick:()=>H("programmed"),className:`px-4 py-3 text-sm font-medium transition-colors border-b-2 -mb-px ${_==="programmed"?"text-emerald-400 border-emerald-400":"text-gray-400 border-transparent hover:text-white"}`,children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(se,{size:16}),"Programmés (",h.length,")"]})})]})]}),_==="guide"&&e.jsxs(e.Fragment,{children:[N&&e.jsxs("div",{className:"mb-4 p-3 bg-orange-900/20 border border-orange-700/50 rounded-xl flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(me,{className:"text-orange-400 flex-shrink-0",size:20}),e.jsxs("div",{children:[e.jsx("p",{className:"text-orange-400 font-medium text-sm",children:"Limite de requêtes atteinte"}),e.jsxs("p",{className:"text-orange-400/70 text-xs",children:["Veuillez patienter quelques secondes avant de rafraîchir. ",e.jsx("br",{}),"(L'API de récupération du guide TV (EPG) limite les requêtes de façon drastique)."]})]})]}),e.jsx("button",{onClick:Z,className:"px-3 py-1.5 bg-orange-600 hover:bg-orange-500 text-white text-xs font-medium rounded-lg transition-colors",children:"Réessayer"})]}),e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("p",{className:"text-sm text-gray-500",children:[m.length," programmes sur ",new Set(m.map(a=>a.channelUuid)).size," chaînes"]}),e.jsxs("button",{onClick:Q,disabled:i||N,className:"flex items-center gap-2 px-3 py-1.5 bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs font-medium rounded-lg transition-colors disabled:opacity-50",children:[e.jsx(De,{size:14,className:i?"animate-spin":""}),"Actualiser"]})]}),i&&m.length===0?e.jsx("div",{className:"flex items-center justify-center py-16",children:e.jsx(O,{size:32,className:"text-red-400 animate-spin"})}):m.length>0?e.jsx(Ve,{programs:m,onRecord:ie,freeboxUrl:w,onLoadMore:te,onDateChange:oe,timelineStartTimestamp:ne,onTimelineStartChange:t}):e.jsxs("div",{className:"flex flex-col items-center justify-center py-16",children:[e.jsx(xe,{size:48,className:"text-gray-600 mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-white mb-2",children:"Aucun programme disponible"}),e.jsx("p",{className:"text-gray-500 text-center max-w-md",children:"Le guide des programmes n'est pas disponible pour le moment."})]})]}),S&&e.jsxs(e.Fragment,{children:[y&&e.jsxs("div",{className:"mb-6 p-4 bg-red-900/20 border border-red-700/50 rounded-xl flex items-center gap-3",children:[e.jsx(me,{className:"text-red-400 flex-shrink-0"}),e.jsx("p",{className:"text-red-400",children:y})]}),T&&e.jsx("div",{className:"flex items-center justify-center py-16",children:e.jsx(O,{size:32,className:"text-purple-400 animate-spin"})}),!T&&_==="recordings"&&e.jsx(e.Fragment,{children:x.length>0?e.jsx("div",{className:p==="grid"?"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4":"flex flex-col gap-3",children:x.map(a=>e.jsx($e,{recording:a,onDelete:V},a.id))}):e.jsxs("div",{className:"flex flex-col items-center justify-center py-16",children:[e.jsx(ce,{size:48,className:"text-gray-600 mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-white mb-2",children:"Aucun enregistrement"}),e.jsx("p",{className:"text-gray-500 text-center max-w-md",children:"Vos enregistrements TV apparaîtront ici. Programmez un enregistrement depuis le guide TV."})]})}),!T&&_==="programmed"&&e.jsxs(e.Fragment,{children:[!J&&e.jsx(_e,{permission:"pvr",freeboxUrl:w}),h.length>0?e.jsx("div",{className:p==="grid"?"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4":"flex flex-col gap-3",children:h.map(a=>e.jsx(Pe,{programmed:a,onDelete:le},a.id))}):e.jsxs("div",{className:"flex flex-col items-center justify-center py-16",children:[e.jsx(se,{size:48,className:"text-gray-600 mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-white mb-2",children:"Aucune programmation"}),e.jsx("p",{className:"text-gray-500 text-center max-w-md",children:"Programmez des enregistrements depuis le guide des programmes dans Freebox OS."})]})]})]})]}),e.jsx(qe,{isOpen:D,onClose:()=>{j(!1),U(null)},onSave:E,channels:d,prefillProgram:P}),e.jsx(Ae,{isOpen:X,onClose:()=>G(!1),currentConfig:r,onSave:z})]})};export{We as TvPage,We as default};
